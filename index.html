<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            transition: 0.3s !important;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .glass {
            background: rgba(0, 0, 0, 0.1);
            box-shadow: inset 0 4px 6px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.2);
            z-index: 999;
        }
        #seek-bar {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #4a5568;
            outline: none;
            position: relative;
        }
        #seek-bar::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3182ce;
            opacity: 0;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        #seek-bar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3182ce;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        #seek-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: white;
            z-index: 1;
            border-radius: 5px;
        }
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .flashing {
            animation: flash 1s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div id="song-title-modal" class="absolute top-4 left-1/2 transform -translate-x-1/2 glass p-2 rounded-xl shadow-lg text-center text-sm text-white-400 font-semibold">
        Diamonds.mp3
    </div>

    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 glass p-4 rounded-xl shadow-lg w-3/4">
        <div class="flex flex-col items-center justify-between mb-2">
            <input id="audio-file" type="file" accept="audio/*" class="hidden" />
            <div class="flex items-center justify-between w-full">
            <div class="flex items-center">
                <label for="audio-file" id="upload-button" class="cursor-pointer text-white py-2 px-1 rounded flashing">
                <i class="fas fa-upload"></i>
                </label>
                <label for="color-picker" class="cursor-pointer text-white py-2 px-1 rounded">
                    <i id="color-picker-label" class="fas fa-palette"></i>
                </label>
                <input id="color-picker" type="color" value="#ff3296" style="opacity: 0;"/>
            </div>
            <button id="play-pause" class="text-white rounded">
                <i class="fas fa-play"></i>
            </button>
            <span id="time-display">00:00 / 04:03</span>
            </div>
            <input id="seek-bar" type="range" value="0" min="0" max="100" class="w-full mt-2 bg-gray-700 accent-blue-500" />
        </div>
    </div>

    <div class="relative w-full h-full" style="height:100vh;">
        <canvas id="visualizer" class="w-full h-full"></canvas>
    </div>
    <audio preload src="Diamonds.mp3" type="audio/mpeg"/>
    <script>
        const fileInput = document.getElementById('audio-file');
        const playPauseButton = document.getElementById('play-pause');
        const seekBar = document.getElementById('seek-bar');
        const timeDisplay = document.getElementById('time-display');
        const canvas = document.getElementById('visualizer');
        const songTitleModal = document.getElementById('song-title-modal');
        const uploadButton = document.getElementById('upload-button');
        const colorPicker = document.getElementById('color-picker');
        const colorPickerLabel = document.getElementById('color-picker-label');
        const ctx = canvas.getContext('2d');

        let audioContext, audioSource, analyser, audio, dataArray, bufferLength;
        let isPlaying = false;
        let barColor = colorPicker.value;
        colorPickerLabel.style.color = barColor;

        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        window.onload = () => {
            audio = new Audio("./Diamonds.mp3");
            audio.addEventListener('timeupdate', updateSeekBar);
            audio.addEventListener('loadedmetadata', updateTimeDisplay);
            setupAudioContext(audio);
        }

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (audio) {
                audio.pause();
                audio = null;
            }

            const fileURL = URL.createObjectURL(file);
            audio = new Audio(fileURL);
            audio.addEventListener('timeupdate', updateSeekBar);
            audio.addEventListener('loadedmetadata', updateTimeDisplay);
            setupAudioContext(audio);
            songTitleModal.textContent = file.name;
            uploadButton.classList.remove('flashing');
            updateSeekBarColor(0)
            audioContext.resume();
            audio.play();
            playPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
            isPlaying = true;
        });

        function setupAudioContext(audio) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioSource = audioContext.createMediaElementSource(audio);
            analyser = audioContext.createAnalyser();

            audioSource.connect(analyser);
            analyser.connect(audioContext.destination);

            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.9;
            bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);

            drawVisualizer();
        }

        playPauseButton.addEventListener('click', () => {
            if (!audio) return;

            if (isPlaying) {
                audio.pause();
                playPauseButton.innerHTML = '<i class="fas fa-play"></i>';
            } else {
                audioContext.resume();
                audio.play();
                playPauseButton.innerHTML = '<i class="fas fa-pause"></i>';
            }
            isPlaying = !isPlaying;
        });

        function updateSeekBar() {
            if (!audio) return;

            const progress = (audio.currentTime / audio.duration) * 100;
            seekBar.value = progress;
            updateTimeDisplay();
            updateSeekBarColor(progress);
        }

        function updateTimeDisplay() {
            if (!audio) return;

            const formatTime = (time) => {
                const minutes = Math.floor(time / 60).toString().padStart(2, '0');
                const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            };

            timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
        }

        seekBar.addEventListener('input', () => {
            if (!audio) return;

            const seekTime = (seekBar.value / 100) * audio.duration;
            audio.currentTime = seekTime;
            updateSeekBarColor(seekBar.value);
        });

        function updateSeekBarColor(progress) {
            seekBar.style.setProperty('--seek-before-width', `${progress}%`);
            seekBar.style.background = `linear-gradient(to right, white ${progress}%, #4a5568 ${progress}%)`;
        }

        colorPicker.addEventListener('input', (event) => {
            barColor = event.target.value;
            colorPickerLabel.style.color = barColor;
        });

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);

            if (!analyser) return;

            analyser.getByteFrequencyData(dataArray);
            bufferLength = 88;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const barWidth = (canvas.width / bufferLength)-1;
            let barHeight;
            let x = 0;
            
            function hexToRgb(hex) {
                const res = hex.split("#")[1];
                return {
                    r: parseInt(res.slice(0,2), 16),
                    g: parseInt(res.slice(2,4), 16),
                    b: parseInt(res.slice(4,6), 16)
                } 
            }

            for (let i = 0; i < bufferLength; i++) {
                barHeight = (dataArray[i] * (canvas.height / 256));
                const rgb = hexToRgb(barColor);
                ctx.fillStyle = `rgb(${-(canvas.height-barHeight)/(canvas.height / 256)+rgb.r}, ${rgb.g}, ${rgb.b})`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }
    </script>
</body>
</html>
